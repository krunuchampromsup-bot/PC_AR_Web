<script>
    // ✅ 1. ตั้งค่า Firebase Config (ใช้รหัสเดิมของครูนุช)
    const firebaseConfig = {
        apiKey: "AIzaSyAK5UMFATyhnQlq3EDLmG7agFqTKh0BYCM",
        authDomain: "smartcom-ar-quiz.firebaseapp.com",
        projectId: "smartcom-ar-quiz",
        storageBucket: "smartcom-ar-quiz.appspot.com",
        messagingSenderId: "367243958931", 
        appId: "1:367243958931:web:3e3c66f54668b8ec66b8ec" 
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    window.onload = function() {
        if (localStorage.getItem("hardware_quiz_done") === "true") {
            showAlreadyDone();
        }
    };

    // คลังคำถาม (เก็บไว้ในตัวแปรต้นฉบับ)
    const rawQuestions = [
        { q: "อุปกรณ์ใดเปรียบเสมือน 'สมอง' ของคอมพิวเตอร์?", c: ["RAM", "CPU", "SSD"], a: "CPU" },
        { q: "หน่วยความจำสำรองที่ช่วยให้เปิดเครื่องเร็วขึ้นคือ?", c: ["SSD", "PSU", "Mainboard"], a: "SSD" },
        { q: "อุปกรณ์ใดทำหน้าที่เก็บข้อมูลชั่วคราวขณะใช้งาน?", c: ["SSD", "CPU", "RAM"], a: "RAM" },
        { q: "ถ้าคอมพิวเตอร์ไม่มีอุปกรณ์นี้ จะจ่ายไฟเข้าเครื่องไม่ได้?", c: ["CASE", "PSU", "RAM"], a: "PSU" },
        { q: "แผงวงจรขนาดใหญ่ที่เชื่อมอุปกรณ์ทุกชิ้นเข้าด้วยกันคือ?", c: ["Mainboard", "SSD", "CPU"], a: "Mainboard" },
        { q: "ตัวถังที่ช่วยป้องกันฝุ่นและระบายความร้อนเรียกว่า?", c: ["PSU", "Mainboard", "CASE"], a: "CASE" },
        { q: "ความเร็วของ CPU มีหน่วยวัดเป็นอะไร?", c: ["Watt", "GHz", "GB"], a: "GHz" },
        { q: "RAM ย่อมาจากคำว่าอะไร?", c: ["Read Access Memory", "Random Access Memory", "Real Action Memory"], a: "Random Access Memory" },
        { q: "อุปกรณ์ใดต่อไปนี้ทนทานต่อแรงกระแทกได้ดีกว่า?", c: ["Hard Disk", "SSD", "CD-ROM"], a: "SSD" },
        { q: "Socket บนเมนบอร์ดมีไว้สำหรับใส่สิ่งใด?", c: ["CPU", "Power Cable", "Case Fan"], a: "CPU" }
    ];

    let questions = []; // ตัวแปรสำหรับเก็บคำถามที่สุ่มแล้ว
    let currentQ = 0; let score = 0; let seconds = 0; let timerInterval; let isAnswering = false;

    // ✅ ฟังก์ชันสุ่มอาเรย์ (Fisher-Yates Shuffle)
    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function startQuiz() {
        const name = document.getElementById('player-name').value;
        if(!name) return alert("กรุณาใส่ชื่อก่อนครับ");

        // ✅ ทำการสุ่มคำถามก่อนเริ่มเกม
        questions = shuffle([...rawQuestions]); 
        
        // ✅ สุ่มตัวเลือกในแต่ละคำถามด้วย
        questions.forEach(item => {
            item.c = shuffle([...item.c]);
        });

        document.getElementById('setup-screen').classList.add('hidden');
        document.getElementById('quiz-screen').classList.remove('hidden');
        timerInterval = setInterval(() => {
            seconds++;
            document.getElementById('timer').innerText = `เวลา: ${seconds} วินาที`;
        }, 1000);
        showQuestion();
    }

    function showQuestion() {
        isAnswering = false;
        const qData = questions[currentQ];
        document.getElementById('question-text').innerText = qData.q;
        document.getElementById('current-pos').innerText = currentQ + 1;
        const container = document.getElementById('choices-container');
        container.innerHTML = "";

        qData.c.forEach((choice) => {
            const btn = document.createElement('button');
            btn.className = "choice-btn";
            btn.innerText = choice;
            btn.onclick = () => checkAnswer(choice, btn); // เช็คจากข้อความคำตอบแทน Index
            container.appendChild(btn);
        });
    }

    function checkAnswer(userChoice, selectedBtn) {
        if(isAnswering) return;
        isAnswering = true;
        
        const qData = questions[currentQ];
        const allBtns = document.querySelectorAll('.choice-btn');

        if(userChoice === qData.a) {
            score++;
            selectedBtn.classList.add('correct');
            document.getElementById('snd-correct').play();
        } else {
            selectedBtn.classList.add('wrong');
            // วนหาปุ่มที่ถูกเพื่อเฉลยสีเขียว
            allBtns.forEach(btn => {
                if(btn.innerText === qData.a) btn.classList.add('correct');
            });
            document.getElementById('snd-wrong').play();
        }

        setTimeout(() => {
            currentQ++;
            if(currentQ < questions.length) showQuestion();
            else finishGame();
        }, 800);
    }

    function finishGame() {
        clearInterval(timerInterval);
        document.getElementById('snd-finish').play();
        const name = document.getElementById('player-name').value;
        
        database.ref('scores/').push({
            name: name, score: score, time: seconds, timestamp: Date.now()
        }).then(() => {
            localStorage.setItem("hardware_quiz_done", "true");
            localStorage.setItem("last_score", score);
            localStorage.setItem("last_time", seconds);
            localStorage.setItem("user_name", name);
            showResultView();
        });
    }

    function showResultView() {
        document.getElementById('quiz-screen').classList.add('hidden');
        document.getElementById('setup-screen').classList.add('hidden');
        document.getElementById('result-screen').classList.remove('hidden');
        const name = localStorage.getItem("user_name");
        const s = localStorage.getItem("last_score");
        const t = localStorage.getItem("last_time");
        document.getElementById('final-score').innerText = `คุณ ${name} ได้คะแนน: ${s} / 10`;
        document.getElementById('final-time').innerText = `ใช้เวลาไปทั้งหมด: ${t} วินาที`;
        loadLeaderboard();
    }

    function showAlreadyDone() {
        document.getElementById('setup-content').innerHTML = `
            <p style="color: var(--pink); font-weight: bold;">⚠️ คุณได้ทำการทดสอบไปแล้ว</p>
            <p>ระบบอนุญาตให้เข้าสอบได้เพียงคนละ 1 ครั้งเท่านั้นครับ</p>
            <button class="btn" onclick="showResultView()">ดูคะแนนของฉัน/อันดับ</button>
        `;
        document.getElementById('result-header').innerText = "ผลการทดสอบของคุณ";
    }

    function loadLeaderboard() {
        database.ref('scores/').orderByChild('score').limitToLast(10).on('value', (snapshot) => {
            const list = [];
            snapshot.forEach((child) => { list.push(child.val()); });
            list.reverse(); 
            const tbody = document.getElementById('leaderboard-body');
            tbody.innerHTML = list.map(item => `
                <tr>
                    <td>${item.name}</td>
                    <td>${item.score}</td>
                    <td>${item.time} วินาที</td>
                </tr>
            `).join('');
        });
    }
</script>
